language: android

env:
  - secure: "XR/6KbCTj442HJAGevisbMXFvvRlZpTzGxfernJXzBnh8Ut+1ydwNlLQeXcmdPW82wr/xeJqhnOp+ZNRNCw5h5mv3tb5Yz8eYIzJk7VkodtquDxPXFKQQPwyyvCc33zl2psmkBqgzZmljyrohrAj9bghfiIwJrztCpLrlfjqsO9sBYurmqAQI4AUQbbbe2w2X1PtHqGbEzh8uR4JmGVE8YrvWNCvFFrRYWcYBLm33ka8oLT2XxmafqmMukYOL+bmIX4kSzbiJVWqIcz0EV1DtNe7HSyWEZFaUAA6HBn2IsK0FYbiVjl1hqpNfoQJrxsOiY/4B4P+okfKMUgxPd+ZFs2im96YbkzGPa6l5b89gfFgiUTyn5UflIhpWjr88QPBSKiFRsu9Z2k/2STSthP9UKFWY/U4D0kbPeMmmPlephk3g+5KdGY0L3J2+aex1X6UMpYUjJhW4B8xbDbKW2cLxGWUdPLdUynumASz39kwbM6iHxv0KV+9MVfneOtZnBHGbuoJ5x1rWp19SaY1ntJHike+Vl3Ucp/omCdf8BUwbjKwXPCe7wTG+ufNSKDVBlj8GQiJec6Qs+jXWYWWu0wBlpTVH4tnt83drikDpfFJRxh/ajKJjeh6T/+AbhLK4Y9lt2H79gBYEirMiamKo0MYUmI+CCGRDRFOIMlw23euXd4="
  - secure: "TSDZf5nxaZtJ8GtmPWQ2byv9UnWr0eY8LnCIt+ppAS4O15D/kC4D1Q7YNUcpkAfKrscwYEg5kufQjWSSeKuwvypvViB9BeOGp2XUC+EWoF2VP89SIQtYsQl4WWSwByvTLPs5GJCKLpH+KbEbngxI0gkZe3PPGgBiq50/sWolZXlVmsJXOo65DRIJwluttRbg2QgRr2/3jY7Wg0SUzc6bGkSUQ8ZI5X2C2NkDyGG720NCY84Yj2pTevRMHADV4oHyag6xiaQmKP/rwOccIw55sQ7lAJ9ofVoDzGhWs0LtUfT2lZQxdRLQqjWgQ0vv8kQBlEVYIy5pgBgp4Bfs5fwRR5SrmpEatgs2mshYM6crn7O+++9vCh2MW/Ns/GpF3jocc8ooL/3HqVIscKPYPGnpcmuTcgvf5HsxMlEi/dhiezh9yhm4EvZ8YzfWg/uIknd9ltMskKHTZyx9HhTk4jG+M3VeD3eEF87PsFbZAW3qzi2XjMLhentXpvo2PMu+KfFN5uZs4xsF1MaxVa9+SDPIwZmibGkFaGJzkDJ1WSSsv1d97QrjXbNGckrVHXIjDyBkh/3+SiSsB8HSuPH0dZvNJOqjn3g4qZLH+KNVAeCEjQm149B1qk/W0OM91F7ChoU3wdeELAC72aN/475o6jaDPLXPKp0w7wEZ41Wzw8nTOOM="

android:
  components:
    - tools
    - platform-tools
    - tools

    # The BuildTools version used by your project
    - build-tools-27.0.1

    # The SDK version used to compile your project
    - android-27

    - extra-android-m2repository

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

before_install:
  # Decrypt secrets tar
  - openssl aes-256-cbc -K $encrypted_867b4f7f2a7b_key -iv $encrypted_867b4f7f2a7b_iv
    -in secrets.tar.enc -out secrets.tar -d
  # Extract secrets
  - tar xvf secrets.tar
  # Install SDK license so Android Gradle plugin can install deps.
  - mkdir "$ANDROID_HOME/licenses" || true
  - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> "$ANDROID_HOME/licenses/android-sdk-license"
  - echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_HOME/licenses/android-sdk-license"

script:
  - . ./ci/prepare_env.sh
  - ./ci/build_debug.sh
  - ./ci/release_internal_beta.sh

after_success:
  - bash <(curl -s https://codecov.io/bash) -f '*TestCoverage.xml'

before_deploy:
  - ./ci/build_dev_version.sh

deploy:
  provider: releases
  api_key: "${GITHUB_API_KEY}"
  file_glob: true
  file: app/build/outputs/apk/*/*-dev.apk
  skip_cleanup: true
  on:
    tags: true

after_deploy:
  - ./ci/notify_slack.sh

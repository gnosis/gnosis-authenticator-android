language: android

env:
  global:
    - secure: "IJXSFlcvfy7YeWGtK6SQsY/f+gyG/L8r3LdjPbV7JUUVfWWwXRFMuahlkPv4O9E8QjoPkRqNMGjXzBIur9jaZFollky4H4PUNezgu4wnpqZ0PEcV0iECQgZ+/103uFixOfR2d9w7sUW8fMbjlBW+2AVu9jtQekDbxJitOshsMHpiWoI9W2Yv1Hjzf65BQBjmbBEav2bKTPf5NlZ+yGx0lexMGefZhOleNgnkpqy1erALh75IVvASMlJS93iVohNVaGv0ymC9z0RjE9uo5f2ytCaibiXqMV0zROB7gtc5ll/FejPcFdBj9+cgJksJbOus+CNmat1lzONhWWu7pqxxI8fqKsfoEEXUoZL3zcF17Xxk1vvolNE+KDQybsUp088xZgYoDSIYlVDUKeVzH5pOJZ+NUt/TuMKb/u9U72ELKOdmJSgLW8P56xJfhTySVqs3XB1GBqPDxjpfCl4VVyHwf11TXJuyRLAV16o72ZTgB6W7p5MiAi5fjimqavxy1k69MHJy68YDgzRuX9KslXrVN7NGDXJwyeymNKwRS5/3/gHkJO9nOhWVc/W3Dk4r1jnH1PvP5tvtBTbTTcY7GKaR6Bcf8b1OSCfnOf7oHZx75DRaBLo5buO3uST5Vof30fA2VmNkmGeMuzn8ybHB3z/OFP4WaIWyoaNFahVc+2uS2vU="
    - secure: "xT+zrlVM6qqt55rx3hVoxC/wbJ3wcgVDS2YSIsIg/2gAgAPW4HQ+uiLr0WEgSig2Xe+/HQLQeaykD+XCpIYWZi6IFrJKDiikoag28TSrXQD2upoj14uja0502pACjeoy+cXVccb0M3b96GWM3xrdUr4wye9OC+gW//JGsM/Yt1B8tHXzcmq8UO7QcW5kQEpoHH52Sj0nCXnEqGzCqwYjoqfph0sZHowoxxIkObY2+xpsWkdrUWVfI+Lp7lVbNcjY3qXfHQDPHb9JD/pLWxfuThm91kMGjqZ4s/nnVVSiV+BsFy4u48xqrxN23kcjHyxgkMXDhymF+T9CAv0tJWDUicHafoGdv4Muz/eGtxmP9d1p1Qxrgzv0HTmKK3378EgPIspu5DJ++5TJluyh/piCVP2zIgfsZW2akA+oyKZ/Ju28VleZ8fkyTGg1Fd3+F2Plmsg/KFMcOZrV7BgPVfs9Eg7UeuUQ++LXKghElJ+blqs1Uh5HVl3Es0J9ZdZO90FnPtoSfp+1YVmH7vw4ZuiYnOBro8Thnp6c5WSfnfZH9UWwP+u74PYnzkzT/6Ye23XuFYuST+tlx78WbQfGQb0ub2YFQOU46342fFNwUG54WJCExJIh1cCjG1vv39WZL6JNB7DfCA4NMIJTwPJt5r3vUTTOqI7V8e6OR/YUNMP2yRM="

android:
  components:
    - tools
    - platform-tools
    - tools

    # The BuildTools version used by your project
    - build-tools-27.0.1

    # The SDK version used to compile your project
    - android-27

    - extra-android-m2repository

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

before_install:
  # Decrypt secrets tar
  - openssl aes-256-cbc -K $encrypted_867b4f7f2a7b_key -iv $encrypted_867b4f7f2a7b_iv
    -in secrets.tar.enc -out secrets.tar -d
  # Extract secrets
  - tar xvf secrets.tar
  # Install SDK license so Android Gradle plugin can install deps.
  - mkdir "$ANDROID_HOME/licenses" || true
  - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> "$ANDROID_HOME/licenses/android-sdk-license"
  - echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_HOME/licenses/android-sdk-license"

script:
  - . ./ci/prepare_env.sh
  - ./ci/build_dev_version.sh
  - ./ci/build_debug.sh
  - ./ci/release_internal_beta.sh

after_success:
  - bash <(curl -s https://codecov.io/bash) -f '*TestCoverage.xml'

before_deploy:
  - ./ci/build_dev_version.sh

deploy:
  provider: releases
  api_key: "${GITHUB_API_KEY}"
  file_glob: true
  file: app/build/outputs/apk/*/*-dev.apk
  skip_cleanup: true
  on:
    tags: true

after_deploy:
  - ./ci/notify_slack.sh

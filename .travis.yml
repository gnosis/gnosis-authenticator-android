language: android

env:
  global:
    - secure: "tlcz1Jc+cTH6yHVZ2rVYfbt8HFZjX2dchTn8uet97xy+K80D9feoTrks1ekFBFy1Zgwh8Px1KIMb8/s5cIBkPQn0nLmnLcv0qKidzOuNo8wr2LMjEy43Bx1Yq1cfmQFdid70xbecUTueggVzQpJn6s+zf0RhKWr4Sdb+8BfO3CThT7htVeBpnLV1yUpRAJwTT1dYCe0Xt/47fw8HiROp2sP9bTJqu1HHD4xHV3pdt4RVfvrdrqOdjAWwnrcUKXR1VXl0bW2QzXcEWqSyJwy74WmMrUFWA3gYP/+ZLY4HuXNSYMRmTWGcW8uaIcL13eS8vjKKTxQUD/nPxMhE5q320eYj6/JQp6XTcSe/alXVHasePJMzwWP/jei7WZjc+ro0GuV53kYb/i91NhoBs43D0IHqv73HCUyCDDiAvG4/G8bDljraNezy9lXaBa6m1NTE9E0Y6HPZ9N6DbA2yA85R+xmDrHT/KH5RxY6wNsusNNZNqRMlBdAq+isaR9fqAcQdwDbRJtzp9hKA78Pvri2W0Ix4GVtEJcH6yHbG9b7m+nKKxAxD5M+g6SOEnN7cCVoU5i90iYQKuWVhp8O7qGRaDOC7eKCWNJ7PLpquqPxquipZTmmfy1ixnZMMbnHvShfa17c/beL4auRvVsGAcZijVkotoknPJfx4nCLoDytVsls="
    - secure: "QGOJ6UzRmsyJnVEyaCMrbZXTUOBRsSa/cNDo/NOuWjwQ9kI7JI47g5F2gDuwvZ47MixVCP/kKP4N3D7hV/T6zvHZ48jbPVUrZAunavwh/V39dstGGVtLocqGHsV1bxB2iyunyTGXII/9tr6uhVrION11mSmA1zSj/CPduo3KpefmqmkqG7L9IJmOhYa9nlBs06gBKGWYJCQNVCEdAmz4J/VSsTRfPcf3WRM8aRAxf9tzgZiHe1AyQn7rqHpCRIrzuSUYUp5guoZzuvNEjBu7yq5eiWC3LWqrkiawsCYYXT7hJ8z4xRNdqX9sMZTJz7sQqci4B+Zd8DVzYM/hQnvXRGw0ALThB+LuouqMwf6XqNRu3RTTOt7ompxMSpdEpdX/Jx9Cbp0ehjeCYNheO8rukLycpBrtr9M+O85tK1BLSlN5JBjJxZh5vssY6YqQBmupjt+PpiYbsIqRT9PIUsJzizGtCFkQ9Swu7i3ZU1fILTIOEhU4XGyLpTNqb1wFruhOeLCWSAT9Q2b0uT/nCLeIZZECuytmKHzTkTWlESv4RW9u2IJ+KrJaN9wCeTOFR6PFF6TqxtPIndbjovugnpt1ElqHUCKIU/jaan73aabBtX0UxBCXvpXv84rPs3HButy+t1eW9F7oEM1iqvypTmLIJcszR6cU2Xl5jH3LARVVpIY="
    
android:
  components:
    - tools
    - platform-tools
    - tools

    # The BuildTools version used by your project
    - build-tools-27.0.1

    # The SDK version used to compile your project
    - android-27

    - extra-android-m2repository

cache:
  directories:
    - $HOME/.gradle/caches/
    - $HOME/.gradle/wrapper/
    - $HOME/.android/build-cache

before_cache:
  - rm -f  $HOME/.gradle/caches/modules-2/modules-2.lock
  - rm -fr $HOME/.gradle/caches/*/plugin-resolution/

before_install:
  # Decrypt secrets tar
  - openssl aes-256-cbc -K $encrypted_867b4f7f2a7b_key -iv $encrypted_867b4f7f2a7b_iv
    -in secrets.tar.enc -out secrets.tar -d
  # Extract secrets
  - tar xvf secrets.tar
  # Install SDK license so Android Gradle plugin can install deps.
  - mkdir "$ANDROID_HOME/licenses" || true
  - echo "8933bad161af4178b1185d1a37fbf41ea5269c55" >> "$ANDROID_HOME/licenses/android-sdk-license"
  - echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> "$ANDROID_HOME/licenses/android-sdk-license"

script:
  - . ./ci/prepare_env.sh
  - ./ci/build_dev_version.sh
  - ./ci/build_debug.sh
  - ./ci/release_internal_beta.sh

after_success:
  - bash <(curl -s https://codecov.io/bash) -f '*TestCoverage.xml'

before_deploy:
  - ./ci/build_dev_version.sh

deploy:
  provider: releases
  api_key: "${GITHUB_API_KEY}"
  file_glob: true
  file: app/build/outputs/apk/*/*-dev.apk
  skip_cleanup: true
  on:
    tags: true

after_deploy:
  - ./ci/notify_slack.sh
